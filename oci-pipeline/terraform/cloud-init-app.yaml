#cloud-config
# Cloud-init para App Server (Frontend + Backend) - CORRIGIDO E ROBUSTO

package_update: true
package_upgrade: false

runcmd:
  # 1. Instalar Docker CE (MÃ©todo Oficial)
  - echo "ğŸ“¦ Instalando DependÃªncias Docker..."
  - dnf install -y dnf-utils zip unzip git
  - dnf config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo
  - dnf install -y docker-ce docker-ce-cli containerd.io
  - systemctl enable --now docker
  - usermod -aG docker opc

  # 2. Instalar Docker Compose V2 (Standalone)
  - echo "ğŸ“¦ Instalando Docker Compose..."
  - curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose
  - ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose

  # 3. Preparar DiretÃ³rio
  - mkdir -p /opt/churninsight
  - chown -R opc:opc /opt/churninsight
  - cd /opt/churninsight

  # 4. Clonar RepositÃ³rio (Branch Main)
  - echo "ğŸš€ Clonando RepositÃ³rio..."
  - git clone https://github.com/Araken13/ML-API-REST-HIBRIDA-HACKATHON-ONE-8.git .

  # 5. Configurar Firewall
  - echo "ğŸ›¡ï¸ Configurando Firewall..."
  - firewall-cmd --permanent --add-port=80/tcp
  - firewall-cmd --permanent --add-port=443/tcp
  - firewall-cmd --permanent --add-port=9999/tcp
  - firewall-cmd --reload

  # 6. Preparar Traefik (HTTPS com nip.io)
  - echo "ğŸ”’ Configurando HTTPS com Traefik e nip.io..."
  - mkdir -p /opt/churninsight/letsencrypt
  - touch /opt/churninsight/letsencrypt/acme.json
  - chmod 600 /opt/churninsight/letsencrypt/acme.json

  # 7. Obter IP PÃºblico e Configurar Ambiente
  - export PUBLIC_IP=$(curl -s ifconfig.me)
  - echo "ğŸŒ IP PÃºblico detectado: $PUBLIC_IP"
  - echo "DOMAIN=$PUBLIC_IP.nip.io" > /opt/churninsight/.env
  - echo "Criado arquivo .env com DOMAIN=$PUBLIC_IP.nip.io"

  # 8. Build e Start
  - echo "ğŸ—ï¸ Subindo AplicaÃ§Ã£o..."
  - /usr/local/bin/docker-compose up -d --build

final_message: "ChurnInsight App Server setup finished at $timestamp"
