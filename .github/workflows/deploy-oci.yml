name: Deploy to OCI

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
    workflow_dispatch:

env:
    OCI_REGION: ${{ secrets.OCI_REGION }}
    OCI_REGISTRY: ${{ secrets.OCI_REGION }}.ocir.io
    OCI_NAMESPACE: ${{ secrets.OCI_REGISTRY_NAMESPACE }}
    PROJECT_NAME: churninsight

jobs:
    # ============================================================================
    # BUILD & PUSH DOCKER IMAGES
    # ============================================================================
    build-and-push:
        name: Build and Push Docker Images
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to OCI Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.OCI_REGISTRY }}
                  username: ${{ secrets.OCI_REGISTRY_USERNAME }}
                  password: ${{ secrets.OCI_REGISTRY_PASSWORD }}

            - name: Build and Push AI Service
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./ai_service/Dockerfile
                  push: ${{ github.event_name != 'pull_request' }}
                  tags: |
                      ${{ env.OCI_REGISTRY }}/${{ env.OCI_NAMESPACE }}/${{ env.PROJECT_NAME }}/ai-service:latest
                      ${{ env.OCI_REGISTRY }}/${{ env.OCI_NAMESPACE }}/${{ env.PROJECT_NAME }}/ai-service:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Build Backend JAR
              run: |
                  ./mvnw clean package -DskipTests

            - name: Build and Push Backend
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile.backend
                  push: ${{ github.event_name != 'pull_request' }}
                  tags: |
                      ${{ env.OCI_REGISTRY }}/${{ env.OCI_NAMESPACE }}/${{ env.PROJECT_NAME }}/backend:latest
                      ${{ env.OCI_REGISTRY }}/${{ env.OCI_NAMESPACE }}/${{ env.PROJECT_NAME }}/backend:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Build and Push Frontend
              uses: docker/build-push-action@v5
              with:
                  context: ./frontend
                  file: ./frontend/Dockerfile
                  push: ${{ github.event_name != 'pull_request' }}
                  tags: |
                      ${{ env.OCI_REGISTRY }}/${{ env.OCI_NAMESPACE }}/${{ env.PROJECT_NAME }}/frontend:latest
                      ${{ env.OCI_REGISTRY }}/${{ env.OCI_NAMESPACE }}/${{ env.PROJECT_NAME }}/frontend:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    # ============================================================================
    # TERRAFORM DEPLOY
    # ============================================================================
    terraform-deploy:
        name: Terraform Deploy
        runs-on: ubuntu-latest
        needs: build-and-push
        if: github.event_name != 'pull_request'

        defaults:
            run:
                working-directory: ./oci-pipeline/terraform

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: 1.6.0

            - name: Configure OCI CLI
              uses: oracle-actions/configure-oci-cli@v1
              with:
                  tenancy-ocid: ${{ secrets.OCI_TENANCY_OCID }}
                  user-ocid: ${{ secrets.OCI_USER_OCID }}
                  fingerprint: ${{ secrets.OCI_FINGERPRINT }}
                  private-key: ${{ secrets.OCI_PRIVATE_KEY }}
                  region: ${{ secrets.OCI_REGION }}

            - name: Terraform Init
              run: terraform init

            - name: Terraform Format Check
              run: terraform fmt -check
              continue-on-error: true

            - name: Terraform Validate
              run: terraform validate

            - name: Terraform Plan
              run: |
                  terraform plan \
                    -var="tenancy_ocid=${{ secrets.OCI_TENANCY_OCID }}" \
                    -var="user_ocid=${{ secrets.OCI_USER_OCID }}" \
                    -var="fingerprint=${{ secrets.OCI_FINGERPRINT }}" \
                    -var="region=${{ secrets.OCI_REGION }}" \
                    -var="compartment_ocid=${{ secrets.OCI_COMPARTMENT_OCID }}" \
                    -var="registry_namespace=${{ secrets.OCI_REGISTRY_NAMESPACE }}" \
                    -out=tfplan

            - name: Terraform Apply
              if: github.ref == 'refs/heads/main'
              run: terraform apply -auto-approve tfplan

            - name: Get Application URL
              if: github.ref == 'refs/heads/main'
              run: |
                  APP_URL=$(terraform output -raw application_url)
                  echo "üöÄ Application deployed at: $APP_URL"
                  echo "APP_URL=$APP_URL" >> $GITHUB_ENV

            - name: Comment PR with URL
              if: github.ref == 'refs/heads/main'
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.repos.createCommitComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        commit_sha: context.sha,
                        body: `‚úÖ Deployment successful!\n\nüåê Application URL: ${process.env.APP_URL}`
                      })

    # ============================================================================
    # HEALTH CHECK
    # ============================================================================
    health-check:
        name: Post-Deployment Health Check
        runs-on: ubuntu-latest
        needs: terraform-deploy
        if: github.ref == 'refs/heads/main'

        steps:
            - name: Wait for deployment
              run: sleep 60

            - name: Check Application Health
              run: |
                  # Obter URL do Terraform output (simplificado aqui)
                  # Em produ√ß√£o, voc√™ pegaria do output do job anterior
                  echo "Checking application health..."
                  # curl -f http://$APP_URL/health || exit 1
